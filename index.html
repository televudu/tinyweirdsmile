<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tiny Weird Smile · Storytelling</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="story-entry" id="story-entry" role="button" tabindex="0">
      <div class="story-entry__inner">
        <h1 class="story-entry__title">Tiny Weird Smile</h1>
      </div>
    </div>
    <main class="story-wrapper">
      <section id="intro" class="story-section" data-section="intro">
        <div class="layer layer-front">
          <figure class="parallax-item has-audio-trigger" data-base-y="0">
            <img src="recortadas/intro-front-hoyo.jpg" alt="Intro hoyo" draggable="false" />
          </figure>
          <figure class="parallax-item" data-base-y="22">
            <img src="recortadas/intro-front-llave.jpg" alt="Intro llave" />
          </figure>
        </div>
      </section>

      <section id="ciudad" class="story-section" data-section="ciudad">
        <div class="layer layer-bg">
          <figure class="parallax-item" data-base-y="-12">
            <img src="recortadas/ciudad-bg-edificio.jpg" alt="Ciudad edificio" />
          </figure>
        </div>
        <div class="layer layer-mid">
          <figure class="parallax-item" data-base-y="0">
            <img src="recortadas/ciudad-mid-chicago.jpg" alt="Ciudad Chicago" />
          </figure>
        </div>
        <div class="layer layer-front">
          <figure class="parallax-item" data-base-y="10">
            <img src="recortadas/ciudad-front-chicago.jpg" alt="Ciudad Chicago foto" />
          </figure>
          <figure class="parallax-item" data-base-y="24">
            <img src="recortadas/ciudad-front-mies.jpg" alt="Ciudad Mies" />
          </figure>
          <figure class="parallax-item" data-base-y="38">
            <img src="recortadas/ciudad-front-mies2.jpg" alt="Ciudad Mies 2" />
          </figure>
          <figure class="parallax-item" data-base-y="52">
            <img src="recortadas/ciudad-front-mies3.jpg" alt="Ciudad Mies 3" />
          </figure>
          <figure class="parallax-item" data-base-y="66">
            <img src="recortadas/ciudad-front-mies4.jpg" alt="Ciudad Mies 4" />
          </figure>
          <figure class="parallax-item" data-base-y="80">
            <img src="recortadas/ciudad-front-nuclear.jpg" alt="Ciudad Nuclear" />
          </figure>
        </div>
      </section>

      <section id="noche" class="story-section" data-section="noche">
        <div class="layer layer-bg">
          <figure class="parallax-item" data-base-y="-18">
            <img src="recortadas/noche-bg-grid.jpg" alt="Noche grid" />
          </figure>
          <figure class="parallax-item" data-base-y="-6">
            <img src="recortadas/noche-bg-ojos.jpg" alt="Noche ojos" />
          </figure>
          <figure class="parallax-item" data-base-y="6">
            <img src="recortadas/noche-bg-ojos2.jpg" alt="Noche ojos 2" />
          </figure>
        </div>
        <div class="layer layer-mid">
          <figure class="parallax-item" data-base-y="0">
            <img src="recortadas/noche-mid-guera.jpg" alt="Noche guera" />
          </figure>
          <figure class="parallax-item" data-base-y="16">
            <img src="recortadas/noche-mid-patrulla.jpg" alt="Noche patrulla" />
          </figure>
          <figure class="parallax-item" data-base-y="80">
            <img src="recortadas/noche-front-ojos.jpg" alt="Noche ojos front" />
          </figure>
        </div>
        <div class="layer layer-front">
          <figure class="parallax-item" data-base-y="10">
            <img src="recortadas/noche-front-aura.jpg" alt="Noche aura" />
          </figure>
          <figure class="parallax-item" data-base-y="20">
            <img src="recortadas/noche-front-miles1.jpg" alt="Noche miles 1" />
          </figure>
          <figure class="parallax-item" data-base-y="32">
            <img src="recortadas/noche-front-miles2.jpg" alt="Noche miles 2" />
          </figure>
          <figure class="parallax-item" data-base-y="44">
            <img src="recortadas/noche-front-ninja.jpg" alt="Noche ninja" />
          </figure>
          <figure class="parallax-item" data-base-y="56">
            <img src="recortadas/noche-front-ninja2.jpg" alt="Noche ninja 2" />
          </figure>
          <figure class="parallax-item" data-base-y="68">
            <img src="recortadas/noche-front-ninja3.jpg" alt="Noche ninja 3" />
          </figure>
          <figure class="parallax-item" data-base-y="92">
            <img src="recortadas/noche-front-hoyonegro.webp" alt="Noche hoyo negro" />
          </figure>
          <figure class="parallax-item" data-base-y="104">
            <img src="recortadas/noche-front-cochera.jpg" alt="Noche cochera" />
          </figure>
          <figure class="parallax-item" data-base-y="116">
            <img src="recortadas/noche-front-cochera2.jpg" alt="Noche cochera 2" />
          </figure>
          <figure class="parallax-item" data-base-y="128">
            <img src="recortadas/noche-front-estacionamiento.jpg" alt="Noche estacionamiento" />
          </figure>
          <figure class="parallax-item" data-base-y="140">
            <img src="recortadas/noche-front-mira.jpg" alt="Noche mira" />
          </figure>
        </div>
      </section>

      <section id="universo" class="story-section" data-section="universo">
        <div class="layer layer-bg">
          <figure class="parallax-item" data-base-y="-16">
            <img src="recortadas/universo-bg-supernova.jpg" alt="Universo supernova" />
          </figure>
          <figure class="parallax-item" data-base-y="-2">
            <img src="recortadas/universo-bg-hoyo.jpg" alt="Universo hoyo" />
          </figure>
        </div>
        <div class="layer layer-mid">
          <figure class="parallax-item" data-base-y="6">
            <img src="recortadas/universo-mid-hoyo.jpg" alt="Universo mid hoyo" />
          </figure>
          <figure class="parallax-item" data-base-y="16">
            <img src="recortadas/universo-mid-hoyo2.jpg" alt="Universo mid hoyo 2" />
          </figure>
          <figure class="parallax-item" data-base-y="26">
            <img src="recortadas/universo-mid-hoyo3.jpg" alt="Universo mid hoyo 3" />
          </figure>
          <figure class="parallax-item" data-base-y="36">
            <img src="recortadas/universo-mid-esfera.jpg" alt="Universo mid esfera" />
          </figure>
          <figure class="parallax-item" data-base-y="46">
            <img src="recortadas/universo-mid-esfera2.jpg" alt="Universo mid esfera 2" />
          </figure>
          <figure class="parallax-item" data-base-y="56">
            <img src="recortadas/universo-mid-esfera3.jpg" alt="Universo mid esfera 3" />
          </figure>
          <figure class="parallax-item" data-base-y="66">
            <img src="recortadas/universo-mid-huevo.jpg" alt="Universo huevo" />
          </figure>
          <figure class="parallax-item" data-base-y="76">
            <img src="recortadas/universo-mid-teorica.jpg" alt="Universo teorica" />
          </figure>
        </div>
        <div class="layer layer-front">
          <figure class="parallax-item" data-base-y="18">
            <img src="recortadas/universo-front-baile.jpg" alt="Universo baile" />
          </figure>
          <figure class="parallax-item" data-base-y="28">
            <img src="recortadas/universo-front-esfera4.jpg" alt="Universo esfera 4" />
          </figure>
          <figure class="parallax-item" data-base-y="40">
            <img src="recortadas/universo-front-fuego.jpg" alt="Universo fuego" />
          </figure>
          <figure class="parallax-item" data-base-y="52">
            <img src="recortadas/universo-front-hoyo3.jpg" alt="Universo hoyo 3" />
          </figure>
          <figure class="parallax-item" data-base-y="64">
            <img src="recortadas/universo-front-kirsten.jpg" alt="Universo Kirsten" />
          </figure>
          <figure class="parallax-item" data-base-y="76">
            <img src="recortadas/universo-front-mirada.jpg" alt="Universo mirada" />
          </figure>
          <figure class="parallax-item" data-base-y="88">
            <img src="recortadas/universo-front-perlas.jpg" alt="Universo perlas" />
          </figure>
          <figure class="parallax-item" data-base-y="100">
            <img src="recortadas/universo-front-poseido.jpg" alt="Universo poseído" />
          </figure>
          <figure class="parallax-item" data-base-y="112">
            <img src="recortadas/universo-front-sombra.jpg" alt="Universo sombra" />
          </figure>
          <figure class="parallax-item" data-base-y="124">
            <img src="recortadas/universo-front-teorema.jpg" alt="Universo teorema" />
          </figure>
        </div>
      </section>

      <section id="jardin" class="story-section" data-section="jardin">
        <div class="layer layer-bg">
          <figure class="parallax-item" data-base-y="-10">
            <img src="recortadas/jardin-bg-bosco.jpg" alt="Jardín bosco" />
          </figure>
        </div>
        <div class="layer layer-mid">
          <figure class="parallax-item" data-base-y="0">
            <img src="recortadas/jardin-mid-cabeza.jpg" alt="Jardín cabeza" />
          </figure>
        </div>
        <div class="layer layer-front">
          <figure class="parallax-item" data-base-y="12">
            <img src="recortadas/jardin-front-kurt.jpg" alt="Jardín Kurt" />
          </figure>
          <figure class="parallax-item" data-base-y="26">
            <img src="recortadas/jardin-front-mies.jpg" alt="Jardín Mies" />
          </figure>
          <figure class="parallax-item" data-base-y="40">
            <img src="recortadas/jardin-front-edificio.jpg" alt="Jardín edificio" />
          </figure>
          <figure class="parallax-item" data-base-y="54">
            <img src="recortadas/jardin-front-dibujo.jpg" alt="Jardín dibujo" />
          </figure>
          <figure class="parallax-item" data-base-y="68">
            <img src="recortadas/jardin-front-dvndra.jpg" alt="Jardín dvndra" />
          </figure>
          <figure class="parallax-item" data-base-y="82">
            <img src="recortadas/jardin-front-huxley.jpg" alt="Jardín Huxley" />
          </figure>
          <figure class="parallax-item" data-base-y="96">
            <img src="recortadas/jardin-front-huxleydibujo.jpg" alt="Jardín Huxley dibujo" />
          </figure>
          <figure class="parallax-item" data-base-y="110">
            <img src="recortadas/jardin-front-pez.jpg" alt="Jardín pez" />
          </figure>
        </div>
      </section>

      <section id="pintura" class="story-section" data-section="pintura">
        <div class="layer layer-front">
          <figure class="parallax-item" data-base-y="0">
            <img src="recortadas/pintura-front-1.jpg" alt="Pintura 1" />
          </figure>
          <figure class="parallax-item" data-base-y="18">
            <img src="recortadas/pintura-front-2.jpg" alt="Pintura 2" />
          </figure>
          <figure class="parallax-item" data-base-y="36">
            <img src="recortadas/pintura-front-3.jpg" alt="Pintura 3" />
          </figure>
        </div>
      </section>

      <section id="fin" class="story-section" data-section="fin">
        <div class="layer layer-front">
          <figure class="parallax-item" data-base-y="0">
            <img src="recortadas/fin-front-ecuacion.jpg" alt="Fin ecuación" />
          </figure>
        </div>
      </section>
    </main>

    <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
    <script src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js"></script>
    <script src="layout-config.js"></script>
    <script src="app.js"></script>
    <script>
      const storyMusic = new Audio('audio/tinyweirdsmile.m4a');
      storyMusic.loop = true;
      storyMusic.volume = 0.6;

      const entryOverlay = document.getElementById('story-entry');
      const triggerFigure = document.querySelector('.has-audio-trigger');

      const AUTO_SCROLL_SPEED = 60; // px per segundo

      let autoScrollId = null;
      let autoScrollActive = false;
      let lastAutoScrollTick = null;
      let autoScrollResidual = 0;
      let autoScrollStartTimeout = null;

      function ensureMusicPlaying() {
        if (storyMusic.paused) {
          storyMusic.play().catch(() => {});
        }
      }

      function toggleMusic() {
        if (storyMusic.paused) {
          storyMusic.play().then(() => {
            scheduleAutoScroll(0);
          }).catch(() => {});
        } else {
          storyMusic.pause();
          stopAutoScroll();
        }
      }

      function scheduleAutoScroll(delay = 0) {
        if (autoScrollStartTimeout !== null) {
          clearTimeout(autoScrollStartTimeout);
        }
        autoScrollStartTimeout = setTimeout(() => {
          autoScrollStartTimeout = null;
          startAutoScroll();
        }, Math.max(0, delay));
      }

      function startAutoScroll() {
        if (autoScrollActive) {
          return;
        }
        autoScrollActive = true;
        lastAutoScrollTick = performance.now();
        autoScrollResidual = 0;

        function step(time) {
          if (!autoScrollActive) {
            return;
          }

          const now = time;
          const delta = Math.min(now - lastAutoScrollTick, 120);
          lastAutoScrollTick = now;

          autoScrollResidual += (delta / 1000) * AUTO_SCROLL_SPEED;
          const stepDistance = Math.floor(autoScrollResidual);
          if (stepDistance <= 0) {
            autoScrollId = requestAnimationFrame(step);
            return;
          }

          autoScrollResidual -= stepDistance;

          const previousScroll = window.scrollY;
          window.scrollBy(0, stepDistance);

          const maxScroll = Math.max(0, document.documentElement.scrollHeight - window.innerHeight);
          const newScroll = window.scrollY;

          if (newScroll >= maxScroll - 1 && maxScroll > 0) {
            window.scrollTo({ top: 0, behavior: 'auto' });
            lastAutoScrollTick = performance.now();
            autoScrollResidual = 0;
            if (window.ScrollTrigger?.refresh) {
              ScrollTrigger.refresh();
            }
            autoScrollId = requestAnimationFrame(step);
            return;
          }

          if (newScroll === previousScroll && previousScroll < maxScroll - 1) {
            autoScrollId = requestAnimationFrame(step);
            return;
          }

          autoScrollId = requestAnimationFrame(step);
        }

        autoScrollId = requestAnimationFrame(step);
      }

      function stopAutoScroll() {
        if (!autoScrollActive) {
          if (autoScrollStartTimeout !== null) {
            clearTimeout(autoScrollStartTimeout);
            autoScrollStartTimeout = null;
          }
          return;
        }
        autoScrollActive = false;
        autoScrollResidual = 0;
        if (autoScrollId !== null) {
          cancelAnimationFrame(autoScrollId);
          autoScrollId = null;
        }
        if (autoScrollStartTimeout !== null) {
          clearTimeout(autoScrollStartTimeout);
          autoScrollStartTimeout = null;
        }
      }

      function userInteractionNudge() {
        if (!autoScrollActive) {
          return;
        }
        lastAutoScrollTick = performance.now();
      }

      ['wheel', 'touchstart', 'touchmove', 'keydown', 'mousedown'].forEach((eventName) => {
        window.addEventListener(eventName, userInteractionNudge, { passive: true });
      });

      function enterStory() {
        ensureMusicPlaying();
        window.scrollTo(0, 0);
        scheduleAutoScroll(1000);
        if (!entryOverlay) {
          return;
        }
        if (entryOverlay.classList.contains('is-dismissed')) {
          return;
        }
        entryOverlay.classList.add('is-dismissed');
        setTimeout(() => {
          entryOverlay.setAttribute('aria-hidden', 'true');
        }, 650);
      }

      entryOverlay?.addEventListener('click', () => {
        enterStory();
      });

      entryOverlay?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          enterStory();
        }
      });

      triggerFigure?.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleMusic();
      });
    </script>
  </body>
</html>
